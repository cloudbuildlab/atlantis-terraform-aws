version: 3
# Automerge: After apply succeeds, automatically merge the PR
# Note: This does NOT auto-apply - someone still needs to comment "atlantis apply"
# To auto-apply on PR approval, use GitHub Actions to comment "atlantis apply" when PR is approved
automerge: true
projects:
  - name: terraform-aws-dev
    dir: dev/ # Directory-based, not workspace
    workflow: atlantis-terraform-aws-dev-workflow # References server-side workflow
    autoplan:
      enabled: true
      when_modified:
        - "**/*.tf"
        - "dev/**"
        - "atlantis.yaml"
    apply_requirements:
      - approved # PR must be approved before apply
      # Note: Policy checks are enabled server-side and run automatically
      # They will block applies if policies fail (unless approved by policy owners)
      # Note: automerge will merge PR after apply succeeds, but apply still requires manual "atlantis apply" comment

  - name: terraform-aws-prod
    dir: prod/ # Directory-based, not workspace
    workflow: atlantis-terraform-aws-prod-workflow # References server-side workflow
    autoplan:
      enabled: true
      when_modified:
        - "**/*.tf"
        - "prod/**"
        - "atlantis.yaml"
    apply_requirements:
      - approved # PR must be approved
      - mergeable # PR must be mergeable (all checks pass)
      # Note: automerge will merge PR after apply succeeds
      # The workflow includes a team check (only platform team can apply to prod)
